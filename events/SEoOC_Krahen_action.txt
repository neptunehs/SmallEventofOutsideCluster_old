namespace = nep_kai

#First step,on_entering_system_fleet
fleet_event = {
	id = nep_kai.1000
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		has_fleet_flag = nep_inva_fleet
		From = { has_star_flag = nep_inva_system }
	}
	
	immediate = {
		closest_system = {
			limit = {
				OR = {
					any_ship_in_system = {
						is_ship_class = shipclass_starbase
						owner = { NOT = { has_country_flag = nep_Krahen_country } }
					}
					any_planet = {
						has_owner = yes
						OR = {
							is_colony = yes
							is_under_colonization = yes
						}
						NOT = { owner = { has_country_flag = nep_Krahen_country } }
					}
				}
			}
			if = {
				limit = {
					any_planet = {
						has_owner = yes
						OR = {
							is_colony = yes
							is_under_colonization = yes
						}
						NOT = { owner = { has_country_flag = nep_Krahen_country } }
					}
				}
				random_system_planet = {
					limit = {
						has_owner = yes
						OR = {
							is_colony = yes
							is_under_colonization = yes
						}
						NOT = { owner = { has_country_flag = nep_Krahen_country } }
					}
					root = {
						auto_move_to_planet = {
							target = prev
							clear_auto_move_on_arrival = yes
						}
					}
				}
			}
			else = {
				random_system_planet = {
					limit = {
						is_star = yes
					}
				}
				root = {
					auto_move_to_planet = {
						target = prev
						clear_auto_move_on_arrival = yes
					}
				}
			}
		}
		fleet_event = { id = nep_kai.1099 days = 3 }
	}
}

#Find fine planet
fleet_event = {
	id = nep_kai.1001
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		has_fleet_flag = nep_inva_fleet
	}
	
	immediate = {
		closest_system = {
			limit = {
				OR = {
					any_ship_in_system = {
						is_ship_class = shipclass_starbase
						owner = { NOT = { has_country_flag = nep_Krahen_country } }
					}
					any_planet = {
						has_owner = yes
						OR = {
							is_colony = yes
							is_under_colonization = yes
						}
						NOT = { owner = { has_country_flag = nep_Krahen_country } }
					}
				}
			}
			if = {
				limit = {
					any_planet = {
						has_owner = yes
						OR = {
							is_colony = yes
							is_under_colonization = yes
						}
						NOT = { owner = { has_country_flag = nep_Krahen_country } }
					}
				}
				random_system_planet = {
					limit = {
						has_owner = yes
						OR = {
							is_colony = yes
							is_under_colonization = yes
						}
						NOT = { owner = { has_country_flag = nep_Krahen_country } }
					}
					root = {
						auto_move_to_planet = {
							target = prev
							clear_auto_move_on_arrival = yes
						}
					}
				}
			}
			else = {
				random_system_planet = {
					limit = {
						is_star = yes
					}
				}
				root = {
					auto_move_to_planet = {
						target = prev
						clear_auto_move_on_arrival = yes
					}
				}
			}
		}
		fleet_event = { id = nep_kai.1099 days = 3 }
	}
}

#find planet and orbit,on_fleet_auto_move_arrival version
country_event = {
	id = nep_kai.1010
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		From = {
			has_fleet_flag = nep_inva_fleet
		}
	}
	
	immediate = {
		if = {
			limit = { 
				from = {
					has_fleet_flag = nep_Krahen_fleet_no_tanks
					solar_system = {
						any_planet = {
							is_colony = yes
							has_owner = yes
							owner = { has_country_flag = nep_Krahen_country }
						}
					}
				}
			}
			from = { 
				remove_fleet_flag = nep_Krahen_fleet_no_tanks
				queue_actions = {
					find_closest_planet = {
						trigger = {
							id = "nep_Krahen.trigger.1010"
							has_owner = yes
							is_colony = yes
							owner = { is_same_value = event_target:nep_Krahen_country }
						}
						found_planet = {
							move_to = this
							orbit_planet = THIS
							effect = {
								id = "nep_Krahen.trigger.1010.1"
								prev = { fleet_event = { id = nep_kai.1001 } }
							}
						}
					}
				}
			}
		}
		else_if = {
			limit = {
				From = {
					solar_system = {
						any_planet = {
							has_owner = yes
							OR = {
								is_colony = yes
								is_under_colonization = yes
							}
							NOT = { owner = { has_country_flag = nep_Krahen_country } }
						}
					}
				}
			}
			From = {
				queue_actions = {
					find_closest_planet = {
						trigger = {
							id = "nep_Krahen.trigger.1010.2"
							has_owner = yes
							is_colony = yes
							NOT = { owner = { is_same_value = event_target:nep_Krahen_country } }
						}
						found_planet = {
							move_to = this
							orbit_planet = THIS
						}
					}
				}
			}
		}
		else = {
			From = { fleet_event = { id = nep_kai.1001 } }
		}
	}	
}

#find planet and orbit
fleet_event = {
	id = nep_kai.1011
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		has_fleet_flag = nep_inva_fleet
	}
	
	immediate = {
		if = {
			limit = { 
				has_fleet_flag = nep_Krahen_fleet_no_tanks
				solar_system = {
					any_planet = {
						is_colony = yes
						has_owner = yes
						owner = { has_country_flag = nep_Krahen_country }
					}
				}
			}
			remove_fleet_flag = nep_Krahen_fleet_no_tanks
			queue_actions = {
				find_closest_planet = {
					trigger = {
						id = "nep_Krahen.trigger.1011"
						has_owner = yes
						is_colony = yes
						owner = { is_same_value = event_target:nep_Krahen_country }
					}
					found_planet = {
						move_to = this
						orbit_planet = THIS
						effect = {
							id = "nep_Krahen.trigger.1011.1"
							prev = { fleet_event = { id = nep_kai.1001 } }
						}
					}
				}
			}
		}
		else_if = {
			limit = {
				solar_system = {
					any_planet = {
						has_owner = yes
						OR = {
							is_colony = yes
							is_under_colonization = yes
						}
						NOT = { owner = { has_country_flag = nep_Krahen_country } }
					}
				}
			}
			queue_actions = {
				find_closest_planet = {
					trigger = {
						id = "nep_Krahen.trigger.1011.2"
						has_owner = yes
						is_colony = yes
						NOT = { owner = { is_same_value = event_target:nep_Krahen_country } }
					}
					found_planet = {
						move_to = this
						orbit_planet = THIS
					}
				}
			}
		}		
		else = {
			fleet_event = { id = nep_kai.1001 }
		}
	}	
}

#found enemy fleet,on_entering_system_fleet
fleet_event = {
	id = nep_kai.1020
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		has_fleet_flag = nep_inva_fleet
		from = {
			any_ship_in_system = {
				owner = { is_hostile = root.owner }
			}
		}
	}
	
	immediate = {
		remove_auto_move_target = yes
		clear_fleet_actions = yes
		from = {
			random_fleet_in_system = {
				limit = {
					owner = { is_hostile = root.owner }
				}
				root = { 
					set_fleet_flag = nep_inva_fleet_attacking_fleet
					auto_follow_fleet = { target = prev attack_fleet = yes }
				}
			}
		}
	}
}

#on_space_battle_won = yes
country_event = {
	id = nep_kai.1021
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		fromfrom = {
			is_in_combat = no
			has_fleet_flag = nep_inva_fleet
			has_fleet_flag = nep_inva_fleet_attacking_fleet
		}
	}
	
	immediate = {
		fromfrom = {
			remove_fleet_flag = nep_inva_fleet_attacking_fleet
			fleet_event = { id = nep_kai.1001 }
		}
	}
}

#on_planet_zero_health,planet attack begin
planet_event = {
	id = nep_kai.1030
	hide_window = yes
	
	is_triggered_only = yes

	trigger = {
		has_global_flag = nep_Krahen_crisis
		NOT = { has_planet_flag = nep_Krahen_invading_planet }
		from = { 
			has_country_flag = nep_Krahen_country
		}
	}
	
	immediate = {
		set_planet_flag = nep_Krahen_invading_planet
		From = {
			every_owned_ship = {
				limit = {
					fleet = {
						NOT = { has_fleet_flag = nep_Krahen_fleet_no_tanks }
						orbit = { is_same_value = root } 
					}
				}
				root = {
						create_army = {
						name = "Krah'en Invader"
						owner = event_target:nep_Krahen_country
						type = nep_Krahen_anti_grav
					}
				}
			}
		}
	}
}

#on_planet_attackers_win,planet attack wins
country_event = {
	id = nep_kai.1031
	hide_window = yes
	
	is_triggered_only = yes

	trigger = {
		has_global_flag = nep_Krahen_crisis
		has_country_flag = nep_Krahen_country
		fromfrom = { has_planet_flag = nep_Krahen_invading_planet }
	}
	
	immediate = {
		fromfrom = { 
			remove_planet_flag = nep_Krahen_invading_planet
			solar_system = {
				if = {
					limit = {
						any_planet = {
							has_owner = yes
							OR = {
								is_colony = yes
								is_under_colonization = yes
							}
							NOT = { owner = { has_country_flag = nep_Krahen_country } }
						}
					}
					every_fleet_in_system = {
						limit = { owner = { has_country_flag = nep_Krahen_country } }
						fleet_event = { id = nep_kai.1011 }
					}
				}
				else = {
					every_fleet_in_system = {
						limit = { owner = { has_country_flag = nep_Krahen_country } }
						fleet_event = { id = nep_kai.1001 }
					}
				}
			}
		}
	}
}

#on_planet_attackers_lose,planet attack loses
country_event = {
	id = nep_kai.1032
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		has_country_flag = nep_Krahen_country
		fromfrom = { has_planet_flag = nep_Krahen_invading_planet }
	}
	
	immediate = {
		fromfrom = {
			solar_system = {
				every_fleet_in_system = {
					limit = { orbit = { has_planet_flag = nep_Krahen_invading_planet } }
					set_fleet_flag = nep_Krahen_fleet_no_tanks
					orbit = { remove_planet_flag = nep_Krahen_invading_planet }
					closest_system = {
						limit = {
							any_planet = {
								is_colony = yes
								has_owner = yes
								owner = { has_country_flag = nep_Krahen_country }
							}
						}
						random_system_planet = {
							limit = {
								is_colony = yes
								has_owner = yes
								owner = { has_country_flag = nep_Krahen_country }
							}
							root = {
								auto_move_to_planet = {
									target = prev
									clear_auto_move_on_arrival = yes
								}
							}
						}
					}
					fleet_event = { id = nep_kai.1098 days = 3 }
				}
			}
		}
	}
}


#on_planet_zero_pops,find colonizer
planet_event = {
	id = nep_kai.1040
	hide_window = yes
	
	is_triggered_only = yes

	trigger = {
		has_global_flag = nep_Krahen_crisis
		from = { 
			owner = { has_country_flag = nep_Krahen_country }
		}
	}
	
	immediate = {
		if = {
			limit = { can_colonize = { who = event_target:nep_Krahen_country status = yes } }
			from = {
				random_owned_ship = {
					limit = {
						is_ship_class = shipclass_colonizer
						is_fleet_idle = yes
					}
					auto_move_to_planet = root
				}
			}
		}
		solar_system = {
			every_fleet_in_system = {
				limit = { orbit = { is_same_value = root } }
				fleet_event = { id = nep_kai.1001 days = 50 }
			}
		}
	}
}

#on_fleet_auto_move_arrival
country_event = {
	id = nep_kai.1041
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_Krahen_crisis
		From = {
			is_ship_class = shipclass_colonizer
			owner = { has_country_flag = nep_Krahen_country }
		}
	}
	
	immediate = {
		from = {
			solar_system = {
				random_system_planet = {
					limit = { can_colonize = { who = event_target:nep_Krahen_country status = yes } }
					start_colony = {
						owner = event_target:nep_Krahen_country 
						species = event_target:nep_Krahen_country
						ethos = owner
					}
				}
			}
			if = {
				limit = { exists = this }
				delete_ship = this
			}
		}
	}
}

#Final solution
fleet_event = {
	id = nep_kai.1098
	hide_window = yes
	
	is_triggered_only = yes

	trigger = {
		is_fleet_idle = yes
		has_fleet_flag = nep_inva_fleet
	}
	
	immediate = {
		if = {
			limit = {
				NOT = { has_fleet_flag = nep_inva_fleet_jumped }
			}
			closest_system = {
				limit = {
					any_planet = {
						is_colony = yes
						has_owner = yes
						owner = { has_country_flag = nep_Krahen_country }
					}
				}
				random_system_planet = {
					root = {
						set_location = prev
						set_timed_fleet_flag = { flag = nep_inva_fleet_jumped days = 200 }						
						fleet_event = { id = nep_kai.1011 }
					}
				}
			}
		}
		else = { fleet_event = { id = nep_kai.1098 days = 200 } }
	}
}

#Final solution
fleet_event = {
	id = nep_kai.1099
	hide_window = yes
	
	is_triggered_only = yes

	trigger = {
		is_fleet_idle = yes
		has_fleet_flag = nep_inva_fleet
	}
	
	immediate = {
		if = {
			limit = {
				NOT = { has_fleet_flag = nep_inva_fleet_jumped }
			}
			closest_system = {
				limit = {
					any_planet = {
						has_owner = yes
						OR = {
							is_colony = yes
							is_under_colonization = yes
						}
						NOT = { owner = { has_country_flag = nep_Krahen_country } }
					}
				}
				random_system_planet = {
					root = {
						set_location = this
						set_timed_fleet_flag = { flag = nep_inva_fleet_jumped days = 200 }
						fleet_event = { id = nep_kai.1011 }
					}
				}
			}
		}
		else = {
			closest_system = {
				min_steps = 1
				max_steps = 3
				random_system_planet = {
					root = {
						auto_move_to_planet = {
							target = prev
							clear_auto_move_on_arrival = yes
						}
					}
				}
			}
			fleet_event = { id = nep_kai.1099 days = 200 }
		}
	}
}