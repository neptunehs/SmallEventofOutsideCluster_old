namespace = nep_inva

#Create cluster,portal
country_event = {
	id = nep_inva.1
	title = "nep_inva.1.name"
	desc = "nep_inva.1.desc"	
	picture = GFX_evt_drifting_gateway

	fire_only_once = yes

	trigger = {
		is_ai = no
		has_global_flag = nep_dragon_end
		has_country_flag = nep_dragon_summoner
	}

	mean_time_to_happen = {
		days = 360
	}

	immediate = {
		#cluster
		set_spawn_system_batch = begin
		no_scope = {
			spawn_system = {
				min_distance >= 565
				max_distance <= 575
				min_orientation_angle = 314
				max_orientation_angle = 316
				hyperlane = no
				initializer = nep_Central_init
			}
		}
		random_system = { 
			limit = { has_star_flag = nep_Central_system }
			spawn_system = {
				min_distance >= 15
				max_distance <= 35
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Centaury_init
			}
			spawn_system = {
				min_distance >= 15
				max_distance <= 35
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Magellan_init
			}
			spawn_system = {
				min_distance >= 15
				max_distance <= 35
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Orion_init
			}
			spawn_system = {
				min_distance >= 20
				max_distance <= 40
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Tra_init
			}
			spawn_system = {
				min_distance >= 20
				max_distance <= 40
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Aurora_init
			}
			spawn_system = {
				min_distance >= 15
				max_distance <= 35
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Andromeda_init
			}
			spawn_system = {
				min_distance >= 20
				max_distance <= 40
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Persei_init
			}
			spawn_system = {
				min_distance >= 20
				max_distance <= 40
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Trantor_init
			}
			spawn_system = {
				min_distance >= 30
				max_distance <= 50
				min_orientation_angle = 0
				max_orientation_angle = 360
				hyperlane = no
				initializer = nep_Exterior_init
			}
		}
		while = {
			limit = {
				any_system = {
					has_star_flag = nep_Krahen_cluster
					check_variable = { which = hyperlane_num value < 3 }
				}
			}
			random_system = {
				limit = {
					has_star_flag = nep_Krahen_cluster
					check_variable = { which = hyperlane_num value < 3 }
				}
				random_system = {
					limit = {
						NOT = { 
							is_same_value = prev 
							has_hyperlane_to = prev
						}
						has_star_flag = nep_Krahen_cluster
						check_variable = { which = hyperlane_num value < 3 }
					}
					add_hyperlane = {
						from = this
						to = prev
					}
					change_variable = { which = hyperlane_num value = 1 }
				}
				change_variable = { which = hyperlane_num value = 1 }
			}
		}
		set_spawn_system_batch = end
		random_planet = {
			limit = {
				has_planet_flag = nep_seal_2
			}
			from = {
				spawn_megastructure = {
					name = "Seal Gate"
					type = nep_sealgate_ruined
					location = prevprev
					orbit_angle = 1
					orbit_distance = 1
				}
			}
		}
		set_global_flag = nep_sealgate_appeared
#		event = { id = nep_inva.1001 days = 7200 random =  1080} 
		
	}
	
	option = {
		name = nep_inva.1.a
	}
}

# country_event = {
	# id = nep_inva.1001
	# hide_window = yes
	
	
	# fire_only_once = yes
	
	# immediate = {
		# if = {
			# limit = { has_global_flag = nep_sealgate_appeared }
			# event = { id = nep_finalweapon.X }
		# }
	# }	
# }

#Create krahen,on_system_first_visited
country_event = {
	id = nep_inva.2
	title = "nep_inva.2.name"
	desc = "nep_inva.2.desc"	
	picture = GFX_evt_fleet_evil

	fire_only_once = yes
	
	is_triggered_only = yes
	
	trigger = {
		is_ai = no
		FROM = { has_star_flag = nep_Krahen_cluster }
		NOT = { has_global_flag = nep_karhen_begin }
	}
	
	immediate = {
		create_species = {
			name = Krah'en
			class = random_non_machine
			portrait = random
			traits = {
				trait = trait_krahen
			}
		}
		create_country = {
			name = "Krah'en Empire"
			species = last_created
			type = nep_Krahen_country
			auto_delete = no
			flag = {
				icon = {
					category = "zoological"
					file = "flag_zoological_10.dds"
				}
				background= {
					category = "backgrounds"
					file = "new_dawn.dds"
				}
				colors={
					"red"
					"black"
					"null"
					"null"
				}
			}
		}
		last_created_country = {
			set_country_flag = nep_Krahen_country
			save_global_event_target_as = nep_Krahen_country
		}
		set_global_flag = nep_karhen_begin
		remove_global_flag = nep_sealgate_appeared
		create_krahen_defender = yes
	}
	
	option = {
		name = nep_inva.2.a
	}
}

#Krah'en crisis begin (HIDDEN)
country_event = {
	id = nep_inva.21
	hide_window = yes
	
	fire_only_once = yes
	
	trigger = {
		has_global_flag = nep_karhen_begin
		any_country = {
			has_country_flag = nep_Krahen_country
			num_fleets < 1
		}
	}
	
	mean_time_to_happen = {
		days = 5
	}
	
	immediate = {
		set_global_flag = nep_krahen_crisis
		set_global_flag = nep_krahen_stage_1
		
		#create krahen colony&invader force
		every_system = {
			limit = { 
				has_star_flag = nep_Krahen_cluster
				NOT = { any_ship_in_system = { owner = { has_country_flag = nep_Krahen_country } } }
			}
			create_starbase = {
				size = nep_heavy_spacebase
				owner = event_target:nep_Krahen_country
			}
			if = {
				limit = { NOT = { has_star_flag = nep_Exterior_system } }
				random_system_planet = {
					limit = {
						is_colony = no
					}
					create_colony = {
						owner = event_target:nep_Krahen_country
						species = event_target:nep_Krahen_country
						ethos = owner
					}
				}
				random_system_planet = {
					limit = {
						is_colony = no
					}
					create_colony = {
						owner = event_target:nep_Krahen_country
						species = event_target:nep_Krahen_country
						ethos = owner
					}
					create_krahen_buildings = yes
					create_krahen_invader = yes
					create_krahen_invader = yes
				}
				random_system_planet = {
					limit = {
						is_colony = no
					}
					create_colony = {
						owner = event_target:nep_Krahen_country
						species = event_target:nep_Krahen_country
						ethos = owner
					}
					create_krahen_buildings = yes
					create_krahen_invader = yes
					create_krahen_invader = yes
				}
			}
		}
		
		#create krahen portal*4&defender force*2
		random_system = {
			limit = { has_star_flag = nep_Central_system }
			random_system_planet = {
				limit = { is_colony = yes }
				create_fleet = {
					name = "NAME_Portal_to_God'Emperor"
					effect = {
						set_owner = event_target:nep_Krahen_country
						create_ship = {
							name = "NAME_Portal_to_God'Emperor"
							design = "NAME_nep_krahen_portal"
							prefix = no
							upgradable = no
							effect = {
								set_ship_flag = nep_krahen_portal_1
							}
						}
						set_event_locked = yes
						set_fleet_flag = nep_krahen_portal_1
					}
				}
				create_krahen_defender = yes
				create_krahen_defender = yes
				create_krahen_transport = yes
				create_krahen_transport = yes
				create_krahen_transport = yes
				create_krahen_transport = yes
				create_krahen_constructor = yes
				create_krahen_constructor = yes
				create_krahen_constructor = yes
				create_krahen_colonizer = yes
				create_krahen_colonizer = yes
			}
		}
		random_system = {
			limit = { 
				has_star_flag = nep_Krahen_cluster
				NOR = {
					has_star_flag = nep_Central_system
					has_star_flag = nep_Exterior_system	
				}
			}
			random_system_planet = {
				limit = { is_colony = yes }
				create_fleet = {
					name = "NAME_Portal_to_God'Emperor"
					effect = {
						set_owner = event_target:nep_Krahen_country
						create_ship = {
							name = "NAME_Portal_to_God'Emperor"
							design = "NAME_nep_krahen_portal"
							prefix = no
							upgradable = no
							effect = {
								set_ship_flag = nep_krahen_portal_2
							}
						}
						set_event_locked = yes
						set_fleet_flag = nep_krahen_portal_2
					}
				}
				create_krahen_defender = yes
				create_krahen_defender = yes
			}
		}
		random_system = {
			limit = { 
				has_star_flag = nep_Krahen_cluster
				NOR = {
					has_star_flag = nep_Central_system
					has_star_flag = nep_Exterior_system	
					has_star_flag = nep_krahen_portal_system
				}
			}
			random_system_planet = {
				limit = { is_colony = yes }
				create_fleet = {
					name = "NAME_Portal_to_God'Emperor"
					effect = {
						set_owner = event_target:nep_Krahen_country
						create_ship = {
							name = "NAME_Portal_to_God'Emperor"
							design = "NAME_nep_krahen_portal"
							prefix = no
							upgradable = no
							effect = {
								set_ship_flag = nep_krahen_portal_3
							}
						}
						set_event_locked = yes
						set_fleet_flag = nep_krahen_portal_3
					}
				}
				create_krahen_defender = yes
				create_krahen_defender = yes
			}
			set_star_flag = nep_krahen_portal_system
		}
		random_system = {
			limit = { 
				has_star_flag = nep_Krahen_cluster
				NOR = {
					has_star_flag = nep_Central_system
					has_star_flag = nep_Exterior_system	
				}
			}
			random_system_planet = {
				limit = { is_colony = yes }
				create_fleet = {
					name = "NAME_Portal_to_God'Emperor"
					effect = {
						set_owner = event_target:nep_Krahen_country
						create_ship = {
							name = "NAME_Portal_to_God'Emperor"
							design = "NAME_nep_krahen_portal"
							prefix = no
							upgradable = no
							effect = {
								set_ship_flag = nep_krahen_portal_4
							}
						}
						set_event_locked = yes
						set_fleet_flag = nep_krahen_portal_4
					}
				}
				create_krahen_defender = yes
				create_krahen_defender = yes
			}
		}
		
		#sealgate
		random_system = {
			limit = {
				has_star_flag = nep_Krahen_cluster
				NOR = { 
					has_star_flag = nep_Central_system 
					has_star_flag = nep_Exterior_system
					any_system_megastructure = {
						OR = { 
							is_megastructure_type = nep_sealgate_ruined
							is_megastructure_type = nep_sealgate_restored
						}
					}
				}
			}
			random_system_planet = {
				limit = { is_star = yes }
				from = {
					spawn_megastructure = {
						name = "Seal Gate"
						type = nep_sealgate_restored
						location = prevprev
						orbit_angle = 128
						orbit_distance = 176
					}
				}
			}
		}
		set_spawn_system_batch = begin
		while = {
			count = 2
			random_system = {
				limit = {
					exists = space_owner
					space_owner = {
						NOR = {
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
						}
					}
					NOT = {
						any_neighbor_system = {
							exists = space_owner
							space_owner = {
								OR = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
								}
							}
						}
					}
				}
				spawn_system = {
					min_distance >= 20
					max_distance <= 30
					initializer = "nep_inva_system_init"
				}
			}
			random_rim_system = {
				limit = {
					exists = space_owner
					space_owner = {
						NOR = {
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
						}
					}
					NOT = {
						any_neighbor_system = {
							exists = space_owner
							space_owner = {
								OR = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
								}
							}
						}
					}
				}
				spawn_system = {
					min_distance >= 20
					max_distance <= 30
					initializer = "nep_inva_system_init"
				}
			}
		}
		every_system = {
			limit = { has_star_flag = nep_inva_system }
			random_system_planet = {
				limit = { is_star = yes }
				from = {
					spawn_megastructure = {
						name = "Seal Gate"
						type = nep_sealgate_restored
						location = prevprev
						orbit_angle = 24
						orbit_distance =  169
					}
				}
			}
			while = {
				count = 3
				random_neighbor_system = {
					limit = {
						NOT = { has_hyperlane_to = prev }
					}
					add_hyperlane = { from = this to = prev }
				}
			}
		}
		set_spawn_system_batch = end
		every_megastructure = {
			limit = {
				is_megastructure_type = nep_sealgate_restored
			}
			activate_gateway = this
		}
		
		#diplomatic
		every_playable_country = {
			establish_communications_no_message = event_target:nep_Krahen_country
			country_event = { id = nep_inva.31 }
		}
	}
}

#3X:diplomatics
#Krah'en crisis diplomatics - crisis begin
country_event = {
	id = nep_inva.31
	title = "nep_inva.31.name"
	desc = "nep_inva.31.desc"

	diplomatic = yes
	
	is_triggered_only = yes
		
	picture_event_data = {
		portrait = event_target:nep_Krahen_country
		planet_background = event_target:nep_Krahen_country
		graphical_culture = event_target:nep_Krahen_country
		city_level = event_target:nep_Krahen_country
		room = event_target:nep_Krahen_country
	}
	
	option = {
		name = nep_inva.31.a
		response_text = nep_inva.31.a.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.31.b
		response_text = nep_inva.31.b.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.31.c
		hidden_effect = {
			begin_event_chain = {
				event_chain = "nep_krahen_invasion_chain"
				target = this
			}
			add_event_chain_counter = {
				event_chain = "nep_krahen_invasion_chain"
				counter = "annexed_worlds"
				amount = 12
			}
		}
	}
}

#Krah'en diplomatics - before crisis
country_event = {
	id = nep_inva.32
	title = "nep_inva.32.name"
	desc = "nep_inva.32.desc"
		
	diplomatic = yes
	
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			has_country_flag = nep_Krahen_country
			NOT = { has_global_flag = nep_krahen_crisis }
		}
	}
	
	picture_event_data = {
		room = no_video_feed_room
	}
	
	option = {
		name = nep_inva.32.a
		response_text = nep_inva.32.a.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.32.b
		response_text = nep_inva.32.a.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.32.c
	}
}

#Krah'en diplomatics - after crisis
country_event = {
	id = nep_inva.33
	title = "nep_inva.33.name"
	desc = "nep_inva.33.desc"
		
	diplomatic = yes
	
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			has_country_flag = nep_Krahen_country
			has_global_flag = nep_krahen_crisis
		}
	}
	
	picture_event_data = {
		portrait = event_target:nep_Krahen_country
		planet_background = event_target:nep_Krahen_country
		graphical_culture = event_target:nep_Krahen_country
		city_level = event_target:nep_Krahen_country
		room = event_target:nep_Krahen_country
	}
	
	option = {
		name = nep_inva.33.a
		response_text = nep_inva.33.a.response
		is_dialog_only = yes
	}
	
	option = {
		name = nep_inva.33.b
	}
}


#4X:krahen actions
#Krahen get a colony,on_planet_attackers_win this = krahen
country_event = {
	id = nep_inva.41
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_krahen_crisis
		has_country_flag = nep_Krahen_country
	}
	
	immediate = {
		FromFrom = {
			every_pop = {
				limit = { NOT = { is_same_species = this } }
				kill_pop = yes
			}
			if = {
				limit = {
					count_tile = {
						count < 4
						limit = {
							has_building = no
							has_blocker = no
						}
					}
				}
				while = {
					count = 4
					random_tile = {
						if = {
							limit = { has_building = yes }
							remove_building = yes
						}
						if = {
							limit = { has_blocker = yes }
							remove_blocker = yes
						}
					}
				}
			}
			create_krahen_buildings = yes
			every_country = {
				limit = { has_event_chain = "nep_krahen_invasion_chain" }
				add_event_chain_counter = {
					event_chain = "nep_krahen_invasion_chain"
					counter = "annexed_worlds"
					amount = 1
				}
			}
		}
	}
}

#Krahen lost a colony,on_planet_attackers_win this = NOT = krahen
country_event = {
	id = nep_inva.42
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_krahen_crisis
		NOT = { has_country_flag = nep_Krahen_country }
		FROM = { has_country_flag = nep_Krahen_country }
	}
	
	immediate = {
		fromfrom = {
			every_pop = {
				limit = { NOT = { is_same_species = this } }
				kill_pop = yes
			}
			every_tile = {
				limit = {
					OR = {
						has_building = nep_adv_tank_factory
						has_building = nep_heavy_fortress
						has_building = nep_heavy_fortress_2
						has_building = nep_planetary_gun
					}
				}
				remove_building = yes
				set_blocker = "tb_bomb_crater"
				every_country = {
					limit = { has_event_chain = "nep_krahen_invasion_chain" }
					add_event_chain_counter = {
						event_chain = "nep_krahen_invasion_chain"
						counter = "annexed_worlds"
						amount = -1
					}
					add_event_chain_counter = {
						event_chain = "nep_krahen_invasion_chain"
						counter = "liberated_worlds"
						amount = 1
					}
				}
			}
		}
		if = {
			limit = {
				NOT = { has_country_flag = nep_krahan_kill_themselves_meet }
			}
			FromFrom = { planet_event = { id = nep_inva.420 } }
		}
	}
}

planet_event = {
	id = nep_inva.420
	title = "nep_inva.420.name"
	desc = "nep_inva.420.desc"	
	picture = GFX_evt_drifting_gateway
	
	is_triggered_only = yes
	
	immediate = {
		owner = { set_country_flag = nep_krahan_kill_themselves_meet }
	}
	
	option = {
		name = nep_inva.420.a
	}
	
	option = {
		name = nep_inva.420.b
	}
}

# krahen Kill Count (HIDDEN)
country_event = {
	id = nep_inva.43
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_country_flag = nep_Krahen_country
		exists = from
	}
	
	immediate = {
		if = {
			limit = {
				FROM = { has_event_chain = "nep_krahen_invasion_chain" }
			}
			FROM = {
				add_event_chain_counter = { 
					event_chain = "nep_krahen_invasion_chain" 
					counter = "krahen_overrun_us" 
					amount = 1 
				}
			}
		}
		every_country = {
			limit = { 
				has_event_chain = "nep_krahen_invasion_chain" 
				NOT = { is_same_value = FROM }
			}
			add_event_chain_counter = { 
				event_chain = "nep_krahen_invasion_chain" 
				counter = "krahen_overrun_others" 
				amount = 1 
			}
		}
	}
}

# krahen Victims (HIDDEN)
country_event = {
	id = nep_inva.44
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_country_flag = nep_Krahen_country
	}
	
	immediate = {
		every_country = {
			limit = { has_event_chain = "nep_krahen_invasion_chain" }
			add_event_chain_counter = { 
				event_chain = "nep_krahen_invasion_chain" 
				counter = "krahen_overruns" 
				amount = 1 
			}
		}
	}
}


#Krahen get a colony,on_colonized
planet_event = {
	id = nep_inva.45
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_krahen_crisis
		owner = { has_country_flag = nep_Krahen_country }
	}
	
	immediate = {
		create_krahen_buildings = yes
		every_country = {
			limit = { has_event_chain = "nep_krahen_invasion_chain" }
			add_event_chain_counter = {
				event_chain = "nep_krahen_invasion_chain"
				counter = "annexed_worlds"
				amount = 1
			}
		}
	}
}

#Krahen force spawn,on_yearly_pulse
event = {
	id = nep_inva.46
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = nep_krahen_crisis
	}
	
	immediate = {
		change_variable = { which = "krahen_years_comes" value = 1 }
		if = {
			limit = {
				check_variable = { 
					which = "krahen_years_comes" 
					value > 5
				}
			}			
			remove_global_flag = nep_krahen_stage_1
			set_global_flag = nep_krahen_stage_2
		}
		if = {
			limit = {
				check_variable = { 
					which = "krahen_years_comes" 
					value > 10
				}
			}
			remove_global_flag = nep_krahen_stage_2
			set_global_flag = nep_krahen_stage_3
		}
		if = {
			limit = {
				check_variable = { 
					which = "krahen_years_comes" 
					value > 15
				}
			}
			remove_global_flag = nep_krahen_stage_3
			set_global_flag = nep_krahen_stage_4
		}
		switch = {
			trigger = has_global_flag
			nep_krahen_stage_1 = {
				if = {
					limit = {
						count_ships = {
							count < 1380
							limit = {
								exists = owner
								owner = { has_country_flag = nep_Krahen_country }
								#OR = {
									#is_ship_size = nep_krahen_corvette
									#is_ship_size = nep_krahen_destroyer
									#is_ship_size = nep_krahen_cruiser
									is_ship_size = nep_krahen_battleship
								#}
							}
						}
					}
					while = {
						count = 4
						random_system = {
							limit = {
								has_star_flag = nep_krahen_portal_system
							}
							random_fleet_in_system = {
								limit = {
									OR = {
										has_fleet_flag = nep_krahen_portal_1
										has_fleet_flag = nep_krahen_portal_2
										has_fleet_flag = nep_krahen_portal_3
										has_fleet_flag = nep_krahen_portal_4
									}
								}
								create_krahen_invader = yes
							}
						}
					}
				}
			}
			nep_krahen_stage_2 = {
				if = {
					limit = {
						count_ships = {
							count < 1680
							limit = {
								exists = owner
								owner = { has_country_flag = nep_Krahen_country }
								#OR = {
									#is_ship_size = nep_krahen_corvette
									#is_ship_size = nep_krahen_destroyer
									#is_ship_size = nep_krahen_cruiser
									is_ship_size = nep_krahen_battleship
								#}
							}
						}
					}
					while = {
						count = 5
						random_system = {
							limit = {
								has_star_flag = nep_krahen_portal_system
							}
							random_fleet_in_system = {
								limit = {
									OR = {
										has_fleet_flag = nep_krahen_portal_1
										has_fleet_flag = nep_krahen_portal_2
										has_fleet_flag = nep_krahen_portal_3
										has_fleet_flag = nep_krahen_portal_4
									}
								}
								create_krahen_invader = yes
							}
						}
					}
				}
			}
			nep_krahen_stage_3 = {
				if = {
					limit = {
						count_ships = {
							count < 1980
							limit = {
								exists = owner
								owner = { has_country_flag = nep_Krahen_country }
								#OR = {
									#is_ship_size = nep_krahen_corvette
									#is_ship_size = nep_krahen_destroyer
									#is_ship_size = nep_krahen_cruiser
									is_ship_size = nep_krahen_battleship
								#}
							}
						}
					}
					while = {
						count = 6
						random_system = {
							limit = {
								has_star_flag = nep_krahen_portal_system
							}
							random_fleet_in_system = {
								limit = {
									OR = {
										has_fleet_flag = nep_krahen_portal_1
										has_fleet_flag = nep_krahen_portal_2
										has_fleet_flag = nep_krahen_portal_3
										has_fleet_flag = nep_krahen_portal_4
									}
								}
								create_krahen_invader = yes
							}
						}
					}
				}
			}
			nep_krahen_stage_4 = {
				if = {
					limit = {
						count_ships = {
							count < 2300
							limit = {
								exists = owner
								owner = { has_country_flag = nep_Krahen_country }
								#OR = {
									#is_ship_size = nep_krahen_corvette
									#is_ship_size = nep_krahen_destroyer
									#is_ship_size = nep_krahen_cruiser
									is_ship_size = nep_krahen_battleship
								#}
							}
						}
					}
					while = {
						count = 7
						random_system = {
							limit = {
								has_star_flag = nep_krahen_portal_system
							}
							random_fleet_in_system = {
								limit = {
									OR = {
										has_fleet_flag = nep_krahen_portal_1
										has_fleet_flag = nep_krahen_portal_2
										has_fleet_flag = nep_krahen_portal_3
										has_fleet_flag = nep_krahen_portal_4
									}
								}
								create_krahen_invader = yes
							}
						}
					}
				}
			}
		}
		every_system = {
			limit = {
				has_star_flag = nep_krahen_portal_system
				NOT = {
					any_ship_in_system = {
						fleet = {
							has_fleet_flag = nep_krahen_defender
						}
					}
				}
			}
			create_krahen_defender = yes
		}
		
		event_target:nep_Krahen_country = {
			every_planet_within_border = {
				limit = {
					is_colony = yes
					has_owner = yes
					owner = { has_country_flag = nep_Krahen_country }
					has_ground_combat = no
					OR = {
						any_tile = { 
							has_building = "nep_heavy_fortress"
							has_pop = yes
						}
						any_tile = { 
							has_building = "nep_heavy_fortress_2"
							has_pop = yes
						}
					}
				}
				if = {
					limit = {
						any_tile = { 
							has_building = "nep_heavy_fortress"
							has_pop = yes
						}
						count_armies = {
							limit = { army_type = nep_krahen_heavy_fortress }
							count < 8
						}
					}
					while = {
						limit = {
							count_armies = {
								limit = { army_type = nep_krahen_heavy_fortress }
								count >= 8
							}
						}
						create_army = {
							name = random
							owner = event_target:nep_Krahen_country
							species = event_target:nep_Krahen_country
							type = nep_krahen_heavy_fortress
						}
					}
				}
				if = {
					limit = {
						any_tile = { 
							has_building = "nep_heavy_fortress_2"
							has_pop = yes
						}
						count_armies = {
							limit = { army_type = nep_krahen_heavy_fortress_2 }
							count < 8
						}
					}
					while = {
						limit = {
							count_armies = {
								limit = { army_type = nep_krahen_heavy_fortress_2 }
								count >= 8
							}
						}
						create_army = {
							name = random
							owner = event_target:nep_Krahen_country
							species = event_target:nep_Krahen_country
							type = nep_krahen_heavy_fortress_2
						}
					}
				}
			}
		}
		while = {
			count = 3
			random_planet = {
				limit = {
					is_colony = yes
					has_owner = yes
					owner = { has_country_flag = nep_Krahen_country }
					has_ground_combat = no
					solar_system = {
						NOT = {
							any_ship_in_system = {
								owner = { NOT = { has_country_flag = nep_Krahen_country } }
							}
						}
					}
				}
				create_krahen_constructor = yes
			}
		}
		while = {
			count = 2
			random_planet = {
				limit = {
					is_colony = yes
					has_owner = yes
					owner = { has_country_flag = nep_Krahen_country }
					has_ground_combat = no
					solar_system = {
						NOT = {
							any_ship_in_system = {
								owner = { NOT = { has_country_flag = nep_Krahen_country } }
							}
						}
					}
				}
				create_krahen_colonizer = yes
			}
		}
		while = {
			count = 5
			random_planet = {
				limit = {
					is_colony = yes
					has_owner = yes
					owner = { has_country_flag = nep_Krahen_country }
					has_ground_combat = no
					solar_system = {
						NOT = {
							any_ship_in_system = {
								owner = { NOT = { has_country_flag = nep_Krahen_country } }
							}
						}
					}
					any_tile = {
						has_building = nep_adv_tank_factory
						has_pop = yes
					}
				}
				create_krahen_transport = yes
			}
		}
	}
}

#unlock portal
country_event = {
	id = nep_inva.47
	hide_window = yes
	
	trigger = {
		has_global_flag = nep_krahen_crisis
		has_country_flag = nep_Krahen_country
		any_system = {
			has_star_flag = nep_krahen_portal_system
			NOT = { has_star_flag = nep_krahen_portal_system_unlocked }
			any_ship_in_system = {
				owner = { NOT = { has_country_flag = nep_Krahen_country } }
			}
		}
	}
	
	immediate = {
		random_system = {
			limit = {
				has_star_flag = nep_krahen_portal_system
				any_ship_in_system = {
					owner = { NOT = { has_country_flag = nep_Krahen_country } }
				}
				NOR = {
					any_ship_in_system = {
						#OR = {
							is_ship_size = nep_krahen_battleship
							#is_ship_size = nep_krahen_cruiser
							#is_ship_size = nep_krahen_destroyer
							#is_ship_size = nep_krahen_corvette
						#}
					}
					any_planet = {
						exists = owner
						owner = {
							has_country_flag = nep_Krahen_country
						}
						is_colony = yes
					}
				}
			}
			random_fleet_in_system = {
				limit = {
					OR = {
						has_fleet_flag = nep_krahen_portal_1
						has_fleet_flag = nep_krahen_portal_2
						has_fleet_flag = nep_krahen_portal_3
						has_fleet_flag = nep_krahen_portal_4
					}
				}
				set_event_locked = no
			}
			remove_star_flag = nep_krahen_portal_system
			set_star_flag = nep_krahen_portal_system_unlocked
			
		}
	}
}

#5X:crisis ends
#portal destoryed,on_ship_destroyed_victim
country_event = {
	id = nep_inva.51
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_country_flag = nep_Krahen_country
		FromFrom = {
			OR = {
				has_fleet_flag = nep_krahen_portal_1
				has_fleet_flag = nep_krahen_portal_2
				has_fleet_flag = nep_krahen_portal_3
				has_fleet_flag = nep_krahen_portal_4			
			}
		}
	}
	
	immediate = {
		FromFrom = {
			switch = {
				trigger = has_fleet_flag
				nep_krahen_portal_1 = { set_global_flag = nep_krahen_portal_1_destroyed }
				nep_krahen_portal_2 = { set_global_flag = nep_krahen_portal_2_destroyed }
				nep_krahen_portal_3 = { set_global_flag = nep_krahen_portal_3_destroyed }
				nep_krahen_portal_4 = { set_global_flag = nep_krahen_portal_4_destroyed }
			}
		}
		if = {
			limit = {
				has_global_flag = nep_krahen_portal_1_destroyed
				has_global_flag = nep_krahen_portal_2_destroyed
				has_global_flag = nep_krahen_portal_3_destroyed
				has_global_flag = nep_krahen_portal_4_destroyed
			}
			country_event = { id = nep_inva.52 }
		}
	}
}

#all portal destoryed
country_event = {
	id = nep_inva.52
	hide_window = yes
	
	is_triggered_only = yes
	
	fire_only_once = yes
	
	immediate = {
		every_owned_ship = {
			destroy_fleet = this
		}
		every_owned_planet = {
			every_owned_pop = {
				kill_pop = yes
			}
			every_tile = {
				limit = {
					OR = {
						has_building = nep_adv_tank_factory
						has_building = nep_heavy_fortress
						has_building = nep_heavy_fortress_2
						has_building = nep_planetary_gun
					}
				}
				remove_building = yes
				set_blocker = "tb_bomb_crater"
			}
			destroy_colony = yes
		}
		destroy_country = yes
		remove_global_flag = nep_karhen_begin
		remove_global_flag = nep_krahen_crisis
		remove_global_flag = nep_krahen_portal_1_destroyed
		remove_global_flag = nep_krahen_portal_2_destroyed
		remove_global_flag = nep_krahen_portal_3_destroyed
		remove_global_flag = nep_krahen_portal_4_destroyed
		set_global_flag = nep_krahen_end
		every_system = {
			limit = {
				has_star_flag = nep_krahen_portal_system
			}
			remove_star_flag = nep_krahen_portal_system
		}
		every_system = {
			limit = {
				has_star_flag = nep_krahen_portal_system_unlocked
			}
			remove_star_flag = nep_krahen_portal_system_unlocked
		}
		every_playable_country = {
			country_event = { id = nep_inva.53 }
		}
	}
}

#Krahen Empire has been defeated.
country_event = {
	id = nep_inva.53
	title = nep_inva.53.name
	desc = nep_inva.53.desc
	picture = GFX_evt_federation_fleet
	show_sound = event_celebration
	
	is_triggered_only = yes
	
	immediate = {
	
	}
	
	option = {
		name = nep_inva.53.a
		add_monthly_resource_mult = {
			resource = unity
			value = 100
			max = 25000
		}
		end_event_chain = nep_krahen_invasion_chain
	}
}

country_event = {
	id = nep_inva.54
	title = nep_inva.54.name
	desc = nep_inva.54.desc
	picture = GFX_evt_physics_research
	
	trigger = {
		has_global_flag = nep_krahen_end
		has_country_flag = nep_dragon_summoner
	}
	
	mean_time_to_happen = {
		days = 720
	}
	
	immediate = {
	
	}
	
	option = {
		name = nep_inva.54.a
		add_monthly_resource_mult = {
			resource = minerals
			value = 2
		}
		add_monthly_resource_mult = {
			resource = energy
			value = 2
		}
		enable_special_project = {
			name = "nep_krahen_explore"
			location = capital_scope
			owner = root
		}
	}
}

planet_event = {
	id = nep_inva.6
	title = nep_inva.6.name
	desc = nep_inva.6.desc
	picture = GFX_evt_hangar_bay
	
	is_triggered_only = yes
	
	immediate = {
		owner = { set_country_flag = nep_krahen_orb_get }
	}
	
	option = {
		name = nep_inva.6.a
		owner = {
			add_monthly_resource_mult = {
				resource = physics_research
				value = @tier3researchreward
			}
			add_monthly_resource_mult = {
				resource = society_research
				value = @tier3researchreward
			}
			add_monthly_resource_mult = {
				resource = engineering_research
				value = @tier3researchreward
			}
			add_research_option = tech_nep_destructor_ray
			add_tech_progress = {
				tech = tech_nep_destructor_ray
				progress = 0.30
			}
		}
	}
}